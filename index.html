<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Brandorivk - Premium Apparel</title>

<!-- Firebase CDN Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
:root{ --primary:#6956ff; --line:#e9edfb; --text:#1a1a2e; --success:#27ae60; --danger:#e74c3c; }
*{ box-sizing:border-box; margin:0; padding:0; }
body{ font-family:Arial, sans-serif; background:#f5f7fb; color:var(--text); }
header{ position:sticky; top:0; background:#fff; padding:15px 5%; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--line); z-index:100; }
.logo{ font-size:1.3rem; font-weight:700; cursor:pointer; }
.header-btns{ display:flex; gap:10px; align-items:center; }
.btn{ padding:8px 14px; border-radius:20px; border:1px solid var(--line); cursor:pointer; background:#fff; font-weight:600; font-size:0.9rem; }
.btn:hover{ background:#f8f9fa; }
.user-info{ display:flex; align-items:center; gap:10px; padding:8px 14px; background:#f8f9fa; border-radius:20px; font-size:0.9rem; }
.user-info span{ font-weight:600; color:var(--primary); }
.user-avatar{ width:32px; height:32px; border-radius:50%; background:var(--primary); color:white; display:flex; align-items:center; justify-content:center; font-weight:bold; }
.hero{ padding:60px 5%; background:linear-gradient(135deg,#171f45,#403ab4); color:#fff; text-align:center; }
.hero h1{ margin-bottom:10px; font-size:2rem; }
.wrap{ max-width:1100px; margin:40px auto; padding:0 5%; }
.grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:25px; }
.card{ background:#fff; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,.08); overflow:hidden; }
.card img{ width:100%; height:280px; object-fit:cover; display:block; background:#f0f0f0; cursor:pointer; }
.info{ padding:18px; }
.price{ font-weight:bold; color:var(--primary); font-size:1.2rem; margin:10px 0; }
.add{ width:100%; padding:12px; border:none; border-radius:8px; background:var(--primary); color:#fff; font-weight:700; cursor:pointer; }
.add:hover{ opacity:0.9; }
.modal{ position:fixed; inset:0; display:none; justify-content:center; align-items:center; background:rgba(0,0,0,.6); z-index:300; padding:20px; }
.modal.open{ display:flex; }
.modal-box{ background:#fff; padding:30px; border-radius:12px; width:100%; max-width:500px; max-height:90vh; overflow-y:auto; position:relative; }
.modal-box h2{ margin-bottom:20px; color:var(--text); }
.form-group{ margin-bottom:15px; }
.form-group label{ display:block; margin-bottom:5px; font-weight:600; color:#333; font-size:0.9rem; }
.form-group input, .form-group textarea, .form-group select{ width:100%; padding:12px; border:2px solid var(--line); border-radius:8px; font-size:1rem; }
.form-group input:focus{ outline:none; border-color:var(--primary); }
.form-row{ display:grid; grid-template-columns:1fr 1fr; gap:15px; }
.submit-btn{ width:100%; padding:15px; background:var(--success); color:#fff; border:none; border-radius:8px; font-size:1.1rem; font-weight:700; cursor:pointer; margin-top:10px; }
.submit-btn:hover{ opacity:0.9; }
.cancel-btn{ width:100%; padding:12px; border:2px solid var(--line); background:#fff; border-radius:8px; cursor:pointer; margin-top:10px; font-weight:600; }
.auth-tabs{ display:flex; gap:10px; margin-bottom:20px; border-bottom:2px solid var(--line); }
.auth-tab{ flex:1; padding:10px; background:none; border:none; cursor:pointer; font-weight:600; font-size:1rem; }
.auth-tab.active{ color:var(--primary); border-bottom:3px solid var(--primary); margin-bottom:-2px; }
.cart-modal{ position:fixed; inset:0; display:none; justify-content:flex-end; background:rgba(0,0,0,.4); z-index:200; }
.cart-modal.open{ display:flex; }
.cart-panel{ width:400px; max-width:90%; background:#fff; height:100%; padding:20px; display:flex; flex-direction:column; }
.cart-header{ display:flex; justify-content:space-between; align-items:center; padding-bottom:15px; border-bottom:1px solid var(--line); margin-bottom:15px; }
.cart-items{ flex:1; overflow-y:auto; }
.cart-item{ display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid var(--line); }
.checkout{ border-top:2px solid var(--line); padding-top:15px; margin-top:auto; }
.checkout-btn{ width:100%; padding:12px; border:none; border-radius:8px; background:#1f2350; color:#fff; cursor:pointer; font-weight:600; margin-top:10px; }
.continue-btn{ width:100%; padding:12px; border:2px solid var(--line); background:#fff; border-radius:8px; cursor:pointer; margin-top:10px; font-weight:600; }
.orders-modal{ position:fixed; inset:0; display:none; justify-content:center; align-items:center; background:rgba(0,0,0,.6); z-index:300; padding:20px; }
.orders-modal.open{ display:flex; }
.orders-box{ background:#fff; padding:30px; border-radius:12px; width:100%; max-width:900px; max-height:90vh; overflow-y:auto; position:relative; }
.orders-box h2{ margin-bottom:20px; color:var(--text); }
.order-card{ background:#f8f9fa; padding:20px; border-radius:8px; margin-bottom:20px; border-left:4px solid var(--primary); }
.order-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
.order-id{ font-size:1.1rem; font-weight:700; }
.order-date{ color:#666; font-size:0.9rem; }
.order-status{ padding:6px 12px; border-radius:20px; font-size:0.85rem; font-weight:600; }
.status-confirmed{ background:#fff3cd; color:#856404; }
.status-dispatched{ background:#d1ecf1; color:#0c5460; }
.status-transit{ background:#d4edda; color:#155724; }
.status-delivered{ background:#c3e6cb; color:#155724; }
.order-items{ background:#fff; padding:15px; border-radius:6px; margin:15px 0; }
.order-item{ display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid var(--line); }
.customer-info{ display:grid; grid-template-columns:1fr 1fr; gap:10px; font-size:0.9rem; color:#666; margin:15px 0; }
.customer-info strong{ color:var(--text); }
.order-total{ font-weight:bold; color:var(--primary); font-size:1.2rem; margin-top:15px; padding-top:15px; border-top:2px solid var(--line); }
.toast{ position:fixed; bottom:20px; right:20px; background:var(--success); color:white; padding:12px 24px; border-radius:8px; z-index:1000; display:none; animation:slideIn .3s ease; }
.toast.error{ background:var(--danger); }
@keyframes slideIn{ from{ transform:translateX(100%); opacity:0 } to{ transform:translateX(0); opacity:1 } }
.close-btn{ position:absolute; top:15px; right:20px; border:none; background:none; font-size:28px; cursor:pointer; color:#666; }
.close-btn:hover{ color:#000; }
.empty-state{ text-align:center; padding:3rem; color:#666; }
.empty-state-icon{ font-size:3rem; margin-bottom:1rem; }
.profile-modal{ position:fixed; inset:0; display:none; justify-content:center; align-items:center; background:rgba(0,0,0,.6); z-index:300; padding:20px; }
.profile-modal.open{ display:flex; }
.profile-box{ background:#fff; padding:30px; border-radius:12px; width:100%; max-width:400px; text-align:center; }
.profile-avatar{ width:80px; height:80px; border-radius:50%; background:var(--primary); color:white; display:flex; align-items:center; justify-content:center; font-size:2rem; font-weight:bold; margin:0 auto 20px; }
.profile-name{ font-size:1.3rem; font-weight:700; margin-bottom:5px; }
.profile-email{ color:#666; margin-bottom:20px; }
@media(max-width:768px){ 
  .header-btns{ flex-direction:column; gap:5px; } 
  .form-row{ grid-template-columns:1fr; } 
  .customer-info{ grid-template-columns:1fr; }
  .hero h1{ font-size:1.5rem; }
  .grid{ grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); }
}
</style>
</head>
<body>

<header>
  <div class="logo" onclick="goHome()">üõçÔ∏è Brandorivk</div>
  <div class="header-btns">
    <button class="btn" onclick="checkAdmin()" id="adminBtn" style="display:none;">üë®‚Äçüíº Admin</button>
    <button class="btn" onclick="checkUserAndShowOrders()">üì¶ My Orders</button>
    
    <!-- User Auth Section - Updates after login -->
    <div id="userAuthSection">
      <button class="btn" onclick="showAuthModal()">üë§ Sign In</button>
    </div>
    
    <button class="btn" id="cartBtn">üõí Cart (<span id="cartCount">0</span>)</button>
  </div>
</header>

<section class="hero">
  <h1>Define Your Style</h1>
  <p>Premium streetwear essentials designed for bold everyday fashion.</p>
</section>

<main class="wrap">
  <div id="productGrid">
    <div class="grid" id="grid"></div>
  </div>
</main>

<!-- Cart Modal -->
<div class="cart-modal" id="cartModal">
  <div class="cart-panel">
    <div class="cart-header">
      <h3 style="margin:0;">Your Cart</h3>
      <button id="closeCart" style="border:none;background:none;font-size:24px;cursor:pointer;">√ó</button>
    </div>
    <div class="cart-items" id="cartItems"></div>
    <div class="checkout">
      <p style="display:flex;justify-content:space-between;font-size:1.2rem;margin:15px 0;"><strong>Total:</strong> <strong style="color:var(--primary);">‚Çπ<span id="total">0</span></strong></p>
      <button class="checkout-btn" onclick="checkUserAndCheckout()">Proceed to Checkout</button>
      <button class="continue-btn" onclick="cartModal.classList.remove('open')">Continue Shopping</button>
    </div>
  </div>
</div>

<!-- Auth Modal (Login/Signup) -->
<div class="modal" id="authModal">
  <div class="modal-box" style="max-width:450px;">
    <button class="close-btn" onclick="closeAuthModal()">√ó</button>
    <h2>üë§ Welcome to Brandorivk</h2>
    
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuthTab('signin')" id="signinTab">Sign In</button>
      <button class="auth-tab" onclick="switchAuthTab('signup')" id="signupTab">Sign Up</button>
    </div>
    
    <!-- Sign In Form -->
    <form id="signinForm" onsubmit="userSignIn(event)">
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="signinEmail" required placeholder="your@email.com">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="signinPassword" required placeholder="Enter password">
      </div>
      <button type="submit" class="submit-btn">Sign In</button>
      <button type="button" class="cancel-btn" onclick="closeAuthModal()">Cancel</button>
    </form>
    
    <!-- Sign Up Form -->
    <form id="signupForm" onsubmit="userSignUp(event)" style="display:none;">
      <div class="form-group">
        <label>Full Name</label>
        <input type="text" id="signupName" required placeholder="John Doe">
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="signupEmail" required placeholder="your@email.com">
      </div>
      <div class="form-group">
        <label>Phone</label>
        <input type="tel" id="signupPhone" required placeholder="9876543210">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="signupPassword" required placeholder="Min 6 characters" minlength="6">
      </div>
      <button type="submit" class="submit-btn">Create Account</button>
      <button type="button" class="cancel-btn" onclick="closeAuthModal()">Cancel</button>
    </form>
  </div>
</div>

<!-- User Profile Modal (Shows after login) -->
<div class="profile-modal" id="profileModal">
  <div class="profile-box">
    <button class="close-btn" onclick="closeProfileModal()">√ó</button>
    <div class="profile-avatar" id="profileAvatar">üë§</div>
    <div class="profile-name" id="profileName">User Name</div>
    <div class="profile-email" id="profileEmail">user@email.com</div>
    <div style="margin:20px 0; text-align:left;">
      <p><strong>üìû Phone:</strong> <span id="profilePhone">-</span></p>
      <p><strong>üìÖ Member Since:</strong> <span id="profileJoined">-</span></p>
    </div>
    <button class="btn" onclick="userSignOut()" style="background:var(--danger); color:white; width:100%;">üö™ Sign Out</button>
    <button class="btn" onclick="closeProfileModal(); showOrders()" style="margin-top:10px; width:100%;">üì¶ View My Orders</button>
  </div>
</div>

<!-- Checkout Modal -->
<div class="modal" id="checkoutModal">
  <div class="modal-box">
    <button class="close-btn" onclick="closeCheckoutForm()">√ó</button>
    <h2>üì¶ Checkout</h2>
    <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:20px;">
      <p style="font-weight:600;margin-bottom:10px;">Order Summary:</p>
      <div id="checkoutSummary"></div>
      <p style="margin-top:15px;display:flex;justify-content:space-between;font-size:1.1rem;">
        <strong>Total Amount:</strong> <strong style="color:var(--primary);">‚Çπ<span id="checkoutTotal">0</span></strong>
      </p>
    </div>
    <form id="orderForm" onsubmit="placeOrder(event)">
      <div class="form-group">
        <label>Full Name *</label>
        <input type="text" id="custName" required>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Email *</label>
          <input type="email" id="custEmail" required>
        </div>
        <div class="form-group">
          <label>Phone *</label>
          <input type="tel" id="custPhone" required pattern="[0-9]{10}">
        </div>
      </div>
      <div class="form-group">
        <label>Address *</label>
        <textarea id="custAddress" required rows="3"></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>City *</label>
          <input type="text" id="custCity" required>
        </div>
        <div class="form-group">
          <label>PIN Code *</label>
          <input type="text" id="custPincode" required pattern="[0-9]{6}">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>State *</label>
          <input type="text" id="custState" required>
        </div>
        <div class="form-group">
          <label>Landmark</label>
          <input type="text" id="custLandmark">
        </div>
      </div>
      <button type="submit" class="submit-btn">‚úÖ Place Order</button>
      <button type="button" class="cancel-btn" onclick="closeCheckoutForm()">Cancel</button>
    </form>
  </div>
</div>

<!-- Orders Modal -->
<div class="orders-modal" id="ordersModal">
  <div class="orders-box">
    <button class="close-btn" onclick="closeOrders()">√ó</button>
    <h2>üì¶ My Orders</h2>
    <div id="ordersList" style="margin-top:20px;"></div>
  </div>
</div>

<!-- Admin Login Modal -->
<div class="modal" id="adminLoginModal">
  <div class="modal-box" style="max-width:400px;">
    <button class="close-btn" onclick="closeAdminLogin()">√ó</button>
    <h2>üîê Admin Login</h2>
    <form onsubmit="adminSignIn(event)">
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="adminEmail" required placeholder="admin@brandorivk.com">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="adminPass" required placeholder="Enter password">
      </div>
      <button type="submit" class="submit-btn">Login</button>
      <button type="button" class="cancel-btn" onclick="closeAdminLogin()">Cancel</button>
    </form>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============================================
// üî• YOUR FIREBASE CONFIG
// ============================================
const firebaseConfig = {
  apiKey: "AIzaSyBnYRf-mptGr3oA6ZqmJsjM9m6RCUz4mbM",
  authDomain: "brandorivk-9a3c2.firebaseapp.com",
  projectId: "brandorivk-9a3c2",
  storageBucket: "brandorivk-9a3c2.firebasestorage.app",
  messagingSenderId: "351821603694",
  appId: "1:351821603694:web:8b1181b5eaa2253b3a577f",
  measurementId: "G-WM887NHXE9"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ============================================
// PRODUCTS
// ============================================
const products = [
  { id: 1, name: "Premium Tee", price: 799, image: "https://murali56.wordpress.com/wp-content/uploads/2026/02/whatsapp-image-2026-02-18-at-19.11.49-1.jpeg", description: "100% premium cotton" },
  { id: 2, name: "Urban Shirt", price: 1299, image: "https://murali56.wordpress.com/wp-content/uploads/2026/02/whatsapp-image-2026-02-18-at-19.11.49-1.jpeg", description: "Premium print design" },
  { id: 3, name: "Street Pants", price: 1599, image: "https://murali56.wordpress.com/wp-content/uploads/2026/02/whatsapp-image-2026-02-18-at-19.11.49-1.jpeg", description: "Stretch fabric comfort" },
  { id: 4, name: "Classic Hoodie", price: 1999, image: "https://murali56.wordpress.com/wp-content/uploads/2026/02/whatsapp-image-2026-02-18-at-19.11.49-1.jpeg", description: "Cozy fleece interior" },
  { id: 5, name: "Denim Jacket", price: 2499, image: "https://murali56.wordpress.com/wp-content/uploads/2026/02/whatsapp-image-2026-02-18-at-19.11.49-1.jpeg", description: "Classic cut denim" },
  { id: 6, name: "Cargo Shorts", price: 999, image: "https://murali56.wordpress.com/wp-content/uploads/2026/02/whatsapp-image-2026-02-18-at-19.11.49-1.jpeg", description: "Multiple pockets" }
];

const ORDER_STATUS = { CONFIRMED: 'confirmed', DISPATCHED: 'dispatched', IN_TRANSIT: 'transit', DELIVERED: 'delivered' };
const ADMIN_EMAIL = "admin@brandorivk.com";

// ============================================
// DATA STORAGE
// ============================================
let cart = [];
let orders = [];
let currentUser = null;
let userData = null;

function loadData(){
  try {
    cart = JSON.parse(localStorage.getItem("brandorivk_cart")) || [];
    orders = JSON.parse(localStorage.getItem("brandorivk_orders")) || [];
  } catch(e) { console.error("Load error:", e); }
}

function saveData(){
  try {
    localStorage.setItem("brandorivk_cart", JSON.stringify(cart));
    localStorage.setItem("brandorivk_orders", JSON.stringify(orders));
    return true;
  } catch(e) { console.error("Save error:", e); return false; }
}

loadData();

// ============================================
// üî• FIXED: AUTH STATE LISTENER (Runs on page load)
// ============================================
auth.onAuthStateChanged(async (user) => {
  console.log("üîê Auth state changed:", user ? user.email : "Logged out");
  
  if (user) {
    // User is signed in
    currentUser = user;
    
    // Get user data from Firestore
    try {
      const doc = await db.collection('users').doc(user.uid).get();
      if (doc.exists) {
        userData = doc.data();
        console.log("üë§ User data loaded:", userData);
      }
    } catch (err) {
      console.log("Could not load user data:", err);
      userData = { name: user.email.split('@')[0], email: user.email };
    }
    
    // Update UI immediately
    updateUserUI();
    
  } else {
    // User is signed out
    currentUser = null;
    userData = null;
    updateUserUI();
  }
});

// ============================================
// UI UPDATE FUNCTION (FIXED - Updates header after login)
// ============================================
function updateUserUI(){
  const userAuthSection = document.getElementById("userAuthSection");
  const adminBtn = document.getElementById("adminBtn");
  
  if (currentUser && userData) {
    // ‚úÖ User is logged in - Show profile button
    const initials = (userData.name || currentUser.email).charAt(0).toUpperCase();
    
    userAuthSection.innerHTML = `
      <button class="btn" onclick="showProfileModal()" style="display:flex;align-items:center;gap:8px;">
        <div class="user-avatar">${initials}</div>
        <span>${userData.name || currentUser.email.split('@')[0]}</span>
      </button>
    `;
    
    // Show admin button if admin email
    if (currentUser.email === ADMIN_EMAIL) {
      adminBtn.style.display = 'block';
    } else {
      adminBtn.style.display = 'none';
    }
    
  } else {
    // ‚ùå User is logged out - Show Sign In button
    userAuthSection.innerHTML = '<button class="btn" onclick="showAuthModal()">üë§ Sign In</button>';
    adminBtn.style.display = 'none';
  }
}

// ============================================
// AUTH MODAL FUNCTIONS
// ============================================
function showAuthModal(){
  document.getElementById("authModal").classList.add("open");
  switchAuthTab('signin');
}

function closeAuthModal(){
  document.getElementById("authModal").classList.remove("open");
  document.getElementById("signinForm").reset();
  document.getElementById("signupForm").reset();
}

function switchAuthTab(tab){
  const signinForm = document.getElementById("signinForm");
  const signupForm = document.getElementById("signupForm");
  const signinTab = document.getElementById("signinTab");
  const signupTab = document.getElementById("signupTab");
  
  if(tab === 'signin'){
    signinForm.style.display = 'block';
    signupForm.style.display = 'none';
    signinTab.classList.add('active');
    signupTab.classList.remove('active');
  } else {
    signinForm.style.display = 'none';
    signupForm.style.display = 'block';
    signinTab.classList.remove('active');
    signupTab.classList.add('active');
  }
}

// ============================================
// üî• FIXED: USER SIGN UP (With better error handling)
// ============================================
function userSignUp(e){
  e.preventDefault();
  
  const name = document.getElementById("signupName").value.trim();
  const email = document.getElementById("signupEmail").value.trim().toLowerCase();
  const phone = document.getElementById("signupPhone").value.trim();
  const password = document.getElementById("signupPassword").value;
  
  // Validate
  if (password.length < 6) {
    showToast("Password must be at least 6 characters", "error");
    return;
  }
  
  auth.createUserWithEmailAndPassword(email, password)
    .then((userCredential) => {
      const user = userCredential.user;
      
      // Save user data to Firestore
      return db.collection('users').doc(user.uid).set({
        name: name,
        email: email,
        phone: phone,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        role: 'customer'
      });
    })
    .then(() => {
      showToast("Account created! Welcome, " + name + " üéâ");
      closeAuthModal();
      // Auth state listener will auto-update UI
    })
    .catch((error) => {
      console.error("Sign up error:", error);
      let msg = "Sign up failed";
      if(error.code === 'auth/email-already-in-use') msg = "Email already registered!";
      else if(error.code === 'auth/weak-password') msg = "Password too weak (min 6 chars)";
      else if(error.code === 'auth/invalid-email') msg = "Invalid email format";
      else if(error.code === 'auth/network-request-failed') msg = "Check your internet connection";
      showToast(msg, "error");
    });
}

// ============================================
// üî• FIXED: USER SIGN IN (With better error handling)
// ============================================
function userSignIn(e){
  e.preventDefault();
  
  const email = document.getElementById("signinEmail").value.trim().toLowerCase();
  const password = document.getElementById("signinPassword").value;
  
  auth.signInWithEmailAndPassword(email, password)
    .then(() => {
      // ‚úÖ Sign in successful - Auth listener will auto-update UI
      showToast("Welcome back! üëã");
      closeAuthModal();
      // No need to call updateUserUI() - onAuthStateChanged handles it
    })
    .catch((error) => {
      console.error("Sign in error:", error);
      let msg = "Sign in failed";
      if(error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
        msg = "Invalid email or password";
      } else if(error.code === 'auth/invalid-email') {
        msg = "Invalid email format";
      } else if(error.code === 'auth/network-request-failed') {
        msg = "Check your internet connection";
      }
      showToast(msg, "error");
    });
}

// ============================================
// USER SIGN OUT
// ============================================
function userSignOut(){
  auth.signOut().then(() => {
    showToast("Logged out successfully");
    closeProfileModal();
    // Auth listener will auto-update UI to show "Sign In" button
  });
}

// ============================================
// PROFILE MODAL (Shows user details after login)
// ============================================
function showProfileModal(){
  if (!currentUser || !userData) {
    showAuthModal();
    return;
  }
  
  // Fill profile data
  const initials = (userData.name || currentUser.email).charAt(0).toUpperCase();
  document.getElementById("profileAvatar").textContent = initials;
  document.getElementById("profileName").textContent = userData.name || "User";
  document.getElementById("profileEmail").textContent = userData.email || currentUser.email;
  document.getElementById("profilePhone").textContent = userData.phone || "-";
  
  // Format join date
  if (userData.createdAt && userData.createdAt.toDate) {
    document.getElementById("profileJoined").textContent = userData.createdAt.toDate().toLocaleDateString('en-IN');
  } else {
    document.getElementById("profileJoined").textContent = "Recently";
  }
  
  document.getElementById("profileModal").classList.add("open");
}

function closeProfileModal(){
  document.getElementById("profileModal").classList.remove("open");
}

// ============================================
// ORDER & CART FUNCTIONS
// ============================================
function checkUserAndShowOrders(){
  if(!currentUser){
    showToast("Please sign in to view orders", "error");
    showAuthModal();
  } else {
    showOrders();
  }
}

function checkUserAndCheckout(){
  if(cart.length === 0){ showToast("Cart is empty!", "error"); return; }
  if(!currentUser){
    showToast("Please sign in to checkout", "error");
    cartModal.classList.remove("open");
    showAuthModal();
  } else {
    openCheckoutForm();
  }
}

function checkAdmin(){
  if(currentUser && currentUser.email === ADMIN_EMAIL){
    showAdminPanel();
  } else {
    document.getElementById("adminLoginModal").classList.add("open");
  }
}

function closeAdminLogin(){
  document.getElementById("adminLoginModal").classList.remove("open");
  document.getElementById("adminEmail").value = "";
  document.getElementById("adminPass").value = "";
}

function adminSignIn(e){
  e.preventDefault();
  const email = document.getElementById("adminEmail").value;
  const pass = document.getElementById("adminPass").value;
  
  if(email !== ADMIN_EMAIL){
    showToast("Not an admin account!", "error");
    return;
  }
  
  auth.signInWithEmailAndPassword(email, pass)
    .then(() => {
      showToast("Admin login successful! üîì");
      closeAdminLogin();
      showAdminPanel();
    })
    .catch((error) => {
      showToast("Login failed: " + error.message, "error");
    });
}

function showAdminPanel(){
  if(!currentUser || currentUser.email !== ADMIN_EMAIL){ checkAdmin(); return; }
  const total = orders.length;
  const pending = orders.filter(o => o.status === ORDER_STATUS.CONFIRMED).length;
  const dispatched = orders.filter(o => o.status === ORDER_STATUS.DISPATCHED).length;
  const delivered = orders.filter(o => o.status === ORDER_STATUS.DELIVERED).length;
  alert(`üìä Admin Stats:\n\nTotal Orders: ${total}\nPending: ${pending}\nDispatched: ${dispatched}\nDelivered: ${delivered}`);
}

// ============================================
// DOM & HELPER FUNCTIONS
// ============================================
const grid = document.getElementById("grid");
const cartModal = document.getElementById("cartModal");
const checkoutModal = document.getElementById("checkoutModal");
const ordersModal = document.getElementById("ordersModal");
const cartCount = document.getElementById("cartCount");
const cartItems = document.getElementById("cartItems");
const totalEl = document.getElementById("total");

function formatCurrency(amount){ return "‚Çπ" + Number(amount).toLocaleString('en-IN'); }
function cleanWordPressUrl(url){ return url.trim().split('?')[0].split('#')[0]; }

function renderProducts(){
  grid.innerHTML = products.map(p => {
    const cleanImage = cleanWordPressUrl(p.image);
    return `<div class="card">
      <img src="${cleanImage}" alt="${p.name}" referrerpolicy="no-referrer" crossorigin="anonymous"
           onerror="this.onerror=null; this.src='https://via.placeholder.com/500x500/6956ff/ffffff?text=${encodeURIComponent(p.name)}';">
      <div class="info">
        <h3>${p.name}</h3>
        <p style="color:#666;font-size:0.9rem;margin:5px 0;">${p.description}</p>
        <div class="price">${formatCurrency(p.price)}</div>
        <button class="add" onclick="addToCart(${p.id}); event.stopPropagation();">Add to Cart</button>
      </div>
    </div>`;
  }).join('');
}

function addToCart(id){
  const product = products.find(p => p.id === id);
  if(!product) return;
  const existing = cart.find(i => i.id === id);
  if(existing){ existing.qty++; showToast(`+1 ${product.name} added`); }
  else { cart.push({...product, qty: 1}); showToast(`${product.name} added to cart!`); }
  updateCart(); saveData();
}

function updateCart(){
  const count = cart.reduce((sum, i) => sum + i.qty, 0);
  cartCount.textContent = count;
  const total = cart.reduce((sum, i) => sum + i.price * i.qty, 0);
  totalEl.textContent = Number(total).toLocaleString('en-IN');
  
  if(cart.length === 0){ cartItems.innerHTML = "<div style='text-align:center;padding:2rem;color:#666;'>Your cart is empty üõí</div>"; }
  else {
    cartItems.innerHTML = cart.map((item, i) => `
      <div class="cart-item">
        <div><strong>${item.name}</strong><br><small style='color:#666;'>${formatCurrency(item.price)} √ó ${item.qty}</small></div>
        <div style="display:flex;align-items:center;gap:10px;">
          <strong>${formatCurrency(item.price * item.qty)}</strong>
          <button onclick="removeItem(${i})" style='border:none;background:#e74c3c;color:white;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:12px;'>Remove</button>
        </div>
      </div>`).join('');
  }
}

function removeItem(i){ cart.splice(i, 1); updateCart(); saveData(); showToast("Item removed"); }
function toggleCart(){ cartModal.classList.toggle("open"); if(cartModal.classList.contains("open")) updateCart(); }

function openCheckoutForm(){
  if(cart.length === 0){ showToast("Cart is empty!", "error"); return; }
  const total = cart.reduce((sum, i) => sum + i.price * i.qty, 0);
  document.getElementById("checkoutTotal").textContent = Number(total).toLocaleString('en-IN');
  document.getElementById("checkoutSummary").innerHTML = cart.map(item => `
    <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;">
      <span>${item.name} √ó ${item.qty}</span>
      <span>${formatCurrency(item.price * item.qty)}</span>
    </div>`).join('');
  
  // Pre-fill user info if logged in
  if(currentUser && userData){
    document.getElementById("custName").value = userData.name || "";
    document.getElementById("custEmail").value = userData.email || "";
    document.getElementById("custPhone").value = userData.phone || "";
  }
  checkoutModal.classList.add("open");
}

function closeCheckoutForm(){ checkoutModal.classList.remove("open"); }

function placeOrder(e){
  e.preventDefault();
  if(cart.length === 0){ showToast("Cart is empty!", "error"); return; }
  
  const order = {
    orderId: "ORD-" + Date.now(),
    orderDate: new Date().toLocaleString('en-IN'),
    userId: currentUser ? currentUser.uid : 'guest',
    customer: {
      name: document.getElementById("custName").value,
      email: document.getElementById("custEmail").value,
      phone: document.getElementById("custPhone").value,
      address: document.getElementById("custAddress").value,
      city: document.getElementById("custCity").value,
      pincode: document.getElementById("custPincode").value,
      state: document.getElementById("custState").value,
      landmark: document.getElementById("custLandmark").value || ""
    },
    items: [...cart],
    total: cart.reduce((sum, i) => sum + i.price * i.qty, 0),
    status: ORDER_STATUS.CONFIRMED,
    statusHistory: [{ status: ORDER_STATUS.CONFIRMED, date: new Date().toLocaleString('en-IN'), message: "Order confirmed" }]
  };
  
  orders.unshift(order); saveData();
  
  // Save to Firestore
  if(currentUser){
    db.collection('orders').add(order).catch(err => console.log("Firestore save error:", err));
  }
  
  cart = []; updateCart();
  showToast("Order placed successfully! üéâ");
  closeCheckoutForm(); cartModal.classList.remove("open");
  document.getElementById("orderForm").reset();
  
  setTimeout(() => { alert(`‚úÖ Order Confirmed!\n\nOrder ID: ${order.orderId}\nTotal: ${formatCurrency(order.total)}`); }, 500);
}

function updateOrderStatus(orderId, newStatus){
  const order = orders.find(o => o.orderId === orderId);
  if(!order) return;
  order.status = newStatus;
  const messages = { confirmed: "Order confirmed", dispatched: "Order dispatched", transit: "In transit", delivered: "Delivered" };
  order.statusHistory.push({ status: newStatus, date: new Date().toLocaleString('en-IN'), message: messages[newStatus] });
  saveData(); showToast("Status updated!"); showOrders();
}

function showOrders(){
  const userOrders = currentUser ? orders.filter(o => o.userId === currentUser.uid) : [];
  
  if(userOrders.length === 0){
    document.getElementById("ordersList").innerHTML = `<div class="empty-state"><div class="empty-state-icon">üì¶</div><h3>No orders yet</h3><p>${currentUser ? "You haven't placed any orders." : "Please sign in."}</p></div>`;
  } else {
    document.getElementById("ordersList").innerHTML = userOrders.map(order => {
      const labels = { confirmed: "Confirmed", dispatched: "Dispatched", transit: "In Transit", delivered: "Delivered" };
      const classes = { confirmed: "status-confirmed", dispatched: "status-dispatched", transit: "status-transit", delivered: "status-delivered" };
      return `<div class="order-card">
        <div class="order-header">
          <div><div class="order-id">üì¶ ${order.orderId}</div><div class="order-date">üìÖ ${order.orderDate}</div></div>
          <span class="order-status ${classes[order.status]}">${labels[order.status]}</span>
        </div>
        <div class="order-items">
          ${order.items.map(item => `<div class="order-item"><span>${item.name} √ó ${item.qty}</span><span>${formatCurrency(item.price * item.qty)}</span></div>`).join('')}
        </div>
        <div class="customer-info">
          <div><strong>üë§</strong> ${order.customer.name}</div>
          <div><strong>üìß</strong> ${order.customer.email}</div>
          <div><strong>üìû</strong> ${order.customer.phone}</div>
          <div><strong>üìç</strong> ${order.customer.city} - ${order.customer.pincode}</div>
        </div>
        <div class="order-total">üí∞ <strong>Total: ${formatCurrency(order.total)}</strong></div>
      </div>`;
    }).join('');
  }
  ordersModal.classList.add("open");
}

function closeOrders(){ ordersModal.classList.remove("open"); }

function showToast(msg, type = "success"){
  const t = document.getElementById("toast");
  t.textContent = msg; t.className = "toast" + (type === "error" ? " error" : "");
  t.style.display = "block"; setTimeout(() => t.style.display = "none", 2500);
}

// Event Listeners
document.getElementById("cartBtn").onclick = toggleCart;
document.getElementById("closeCart").onclick = () => cartModal.classList.remove("open");
cartModal.onclick = e => { if(e.target === cartModal) cartModal.classList.remove("open"); };
checkoutModal.onclick = e => { if(e.target === checkoutModal) closeCheckoutForm(); };
ordersModal.onclick = e => { if(e.target === ordersModal) closeOrders(); };
document.getElementById("authModal").onclick = e => { if(e.target === document.getElementById("authModal")) closeAuthModal(); };
document.getElementById("adminLoginModal").onclick = e => { if(e.target === document.getElementById("adminLoginModal")) closeAdminLogin(); };
document.getElementById("profileModal").onclick = e => { if(e.target === document.getElementById("profileModal")) closeProfileModal(); };
document.addEventListener("keydown", e => { if(e.key === "Escape"){ cartModal.classList.remove("open"); closeCheckoutForm(); closeOrders(); closeAuthModal(); closeAdminLogin(); closeProfileModal(); } });

// Initialize
document.addEventListener("DOMContentLoaded", function(){
  console.log("üöÄ Brandorivk loaded with Firebase!");
  renderProducts(); 
  loadData(); 
  updateCart();
  // Auth listener will handle UI updates
});
</script>

</body>
</html>
