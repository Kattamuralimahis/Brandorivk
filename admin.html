<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Brandorivk - Admin Panel</title>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<style>
:root{ --primary:#6956ff; --line:#e9edfb; --text:#1a1a2e; --success:#27ae60; --danger:#e74c3c; --warning:#f39c12; }
*{ box-sizing:border-box; margin:0; padding:0; }
body{ font-family:Arial, sans-serif; background:#f5f7fb; color:var(--text); padding:20px; }
.container{ max-width:1200px; margin:0 auto; }
header{ background:#fff; padding:20px; border-radius:12px; margin-bottom:20px; box-shadow:0 2px 10px rgba(0,0,0,.1); display:flex; justify-content:space-between; align-items:center; }
h1{ color:var(--text); font-size:1.5rem; }
.stats{ display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:15px; margin-bottom:30px; }
.stat-card{ background:linear-gradient(135deg, var(--primary), #403ab4); color:#fff; padding:20px; border-radius:8px; text-align:center; }
.stat-card h3{ font-size:2rem; margin-bottom:5px; }
.stat-card p{ opacity:0.9; font-size:0.9rem; }
.section{ background:#fff; padding:20px; border-radius:12px; margin-bottom:20px; box-shadow:0 2px 10px rgba(0,0,0,.1); }
.section h2{ margin-bottom:20px; color:var(--text); border-bottom:2px solid var(--line); padding-bottom:10px; font-size:1.2rem; }
table{ width:100%; border-collapse:collapse; }
th, td{ padding:12px; text-align:left; border-bottom:1px solid var(--line); font-size:0.9rem; }
th{ background:#f8f9fa; font-weight:600; }
tr:hover{ background:#f8f9fa; }
.btn{ padding:8px 16px; border:none; border-radius:4px; cursor:pointer; font-size:0.85rem; margin:2px; font-weight:600; }
.btn-approve{ background:var(--success); color:#fff; }
.btn-approve:hover{ opacity:0.9; }
.btn-reject{ background:var(--danger); color:#fff; }
.btn-reject:hover{ opacity:0.9; }
.btn-logout{ background:var(--danger); color:#fff; padding:10px 20px; }
.status{ padding:6px 12px; border-radius:20px; font-size:0.85rem; font-weight:600; display:inline-block; }
.status-pending{ background:#ffeaa7; color:#d63031; }
.status-approved{ background:#55efc4; color:#00b894; }
.status-rejected{ background:#fab1a0; color:#d63031; }
.login-box{ max-width:400px; margin:100px auto; background:#fff; padding:40px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.1); }
.login-box h2{ text-align:center; margin-bottom:20px; }
.form-group{ margin-bottom:15px; }
.form-group label{ display:block; margin-bottom:5px; font-weight:600; }
.form-group input{ width:100%; padding:12px; border:2px solid var(--line); border-radius:8px; font-size:1rem; }
.form-group input:focus{ outline:none; border-color:var(--primary); }
.submit-btn{ width:100%; padding:15px; background:var(--primary); color:#fff; border:none; border-radius:8px; font-size:1.1rem; font-weight:700; cursor:pointer; }
.toast{ position:fixed; bottom:20px; right:20px; background:var(--success); color:white; padding:12px 24px; border-radius:8px; z-index:1000; display:none; }
.toast.error{ background:var(--danger); }
.hidden{ display:none; }
.loading{ text-align:center; padding:2rem; color:#666; }
.no-data{ text-align:center; padding:2rem; color:#666; }
.debug-info{ background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:20px; font-size:0.85rem; }
.debug-info code{ background:#fff; padding:2px 6px; border-radius:4px; }
</style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen" class="login-box">
  <h2>üîê Admin Login</h2>
  <form onsubmit="adminLogin(event)">
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="adminEmail" required placeholder="brandorivk@gmail.com">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="adminPassword" required placeholder="Enter password">
    </div>
    <button type="submit" class="submit-btn">Login</button>
  </form>
</div>

<!-- Admin Dashboard -->
<div id="adminDashboard" class="container hidden">
  <header>
    <h1>üë®‚Äçüíº Admin Panel - Payment Verification</h1>
    <button onclick="adminLogout()" class="btn btn-logout">üö™ Logout</button>
  </header>

  <!-- Debug Info -->
  <div class="debug-info">
    <strong>üîç Debug Info:</strong>
    <div id="debugContent">Loading...</div>
  </div>

  <div class="stats">
    <div class="stat-card"><h3 id="statTotal">0</h3><p>Total Orders</p></div>
    <div class="stat-card" style="background:linear-gradient(135deg, #f39c12, #e67e22);"><h3 id="statPending">0</h3><p>Pending Payment</p></div>
    <div class="stat-card" style="background:linear-gradient(135deg, #3498db, #2980b9);"><h3 id="statApproved">0</h3><p>Payment Approved</p></div>
    <div class="stat-card" style="background:linear-gradient(135deg, #27ae60, #229954);"><h3 id="statDelivered">0</h3><p>Delivered</p></div>
  </div>

  <div class="section">
    <h2>‚è≥ All Pending Orders (Approve/Reject Here)</h2>
    <div id="pendingLoading" class="loading">Loading pending orders...</div>
    <table id="pendingTable" style="display:none;">
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Customer</th>
          <th>Amount</th>
          <th>UTR</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="pendingTableBody"></tbody>
    </table>
    <div id="pendingNoData" class="no-data" style="display:none;">No pending orders</div>
  </div>

  <div class="section">
    <h2>‚úÖ Approved Orders</h2>
    <div id="approvedLoading" class="loading">Loading approved orders...</div>
    <table id="approvedTable" style="display:none;">
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Customer</th>
          <th>Amount</th>
          <th>UTR</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="approvedTableBody"></tbody>
    </table>
    <div id="approvedNoData" class="no-data" style="display:none;">No approved orders yet</div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============================================
// FIREBASE CONFIG
// ============================================
const firebaseConfig = {
  apiKey: "AIzaSyBnYRf-mptGr3oA6ZqmJsjM9m6RCUz4mbM",
  authDomain: "brandorivk-9a3c2.firebaseapp.com",
  projectId: "brandorivk-9a3c2",
  storageBucket: "brandorivk-9a3c2.firebasestorage.app",
  messagingSenderId: "351821603694",
  appId: "1:351821603694:web:8b1181b5eaa2253b3a577f",
  measurementId: "G-WM887NHXE9"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const ADMIN_EMAIL = "brandorivk@gmail.com";
const PAYMENT_STATUS = { PENDING: 'pending', APPROVED: 'approved', REJECTED: 'rejected' };

// ============================================
// AUTH
// ============================================
auth.onAuthStateChanged((user) => {
  console.log("üîê Auth state:", user ? user.email : "Logged out");
  
  if (user && user.email === ADMIN_EMAIL) {
    document.getElementById("loginScreen").classList.add("hidden");
    document.getElementById("adminDashboard").classList.remove("hidden");
    loadDashboard();
  } else {
    document.getElementById("loginScreen").classList.remove("hidden");
    document.getElementById("adminDashboard").classList.add("hidden");
  }
});

function adminLogin(e){
  e.preventDefault();
  const email = document.getElementById("adminEmail").value;
  const password = document.getElementById("adminPassword").value;
  
  if(email !== ADMIN_EMAIL){ 
    showToast("Not an admin account!", "error"); 
    return; 
  }
  
  auth.signInWithEmailAndPassword(email, password)
    .then(() => { showToast("Login successful!"); })
    .catch((error) => { showToast("Login failed: " + error.message, "error"); });
}

function adminLogout(){
  auth.signOut().then(() => { showToast("Logged out"); });
}

// ============================================
// DASHBOARD - SIMPLIFIED & FIXED
// ============================================
function loadDashboard(){
  console.log("üìä Loading dashboard...");
  updateDebugInfo("Loading orders from Firestore...");
  
  db.collection('orders').orderBy('orderDate', 'desc').get()
    .then((snapshot) => {
      console.log("üì¶ Orders loaded:", snapshot.size);
      updateDebugInfo(`Loaded ${snapshot.size} orders from Firestore`);
      
      const orders = snapshot.docs.map(doc => ({ 
        id: doc.id, 
        ...doc.data() 
      }));
      
      // Update Stats
      document.getElementById("statTotal").textContent = orders.length;
      document.getElementById("statPending").textContent = orders.filter(o => o.paymentStatus === PAYMENT_STATUS.PENDING).length;
      document.getElementById("statApproved").textContent = orders.filter(o => o.paymentStatus === PAYMENT_STATUS.APPROVED).length;
      document.getElementById("statDelivered").textContent = orders.filter(o => o.status === 'delivered').length;
      
      // Load Pending Orders (ALL pending, with or without UTR)
      loadPendingOrders(orders);
      
      // Load Approved Orders
      loadApprovedOrders(orders);
      
    })
    .catch((err) => { 
      console.error("‚ùå Error loading orders:", err); 
      updateDebugInfo(`Error: ${err.message}`);
      showToast("Error loading orders: " + err.message, "error");
    });
}

function loadPendingOrders(orders){
  const pendingTable = document.getElementById("pendingTable");
  const pendingTableBody = document.getElementById("pendingTableBody");
  const pendingLoading = document.getElementById("pendingLoading");
  const pendingNoData = document.getElementById("pendingNoData");
  
  // Show ALL pending orders (not just those with UTR)
  const pending = orders.filter(o => o.paymentStatus === PAYMENT_STATUS.PENDING);
  
  console.log("‚è≥ Pending orders:", pending.length);
  updateDebugInfo(`Pending orders: ${pending.length}`);
  
  pendingLoading.style.display = 'none';
  
  if(pending.length === 0){
    pendingTable.style.display = 'none';
    pendingNoData.style.display = 'block';
    return;
  }
  
  pendingTable.style.display = 'table';
  pendingNoData.style.display = 'none';
  
  pendingTableBody.innerHTML = pending.map(order => {
    const utr = order.utr || 'Not submitted yet';
    const utrStyle = order.utr ? 'color:var(--success);font-weight:bold;' : 'color:#999;';
    
    return `
      <tr>
        <td><strong>${order.orderId}</strong></td>
        <td>${order.customer.name || 'N/A'}<br><small>${order.customer.email || ''}</small></td>
        <td><strong>‚Çπ${(order.total || 0).toLocaleString('en-IN')}</strong></td>
        <td style="${utrStyle}">${utr}</td>
        <td><span class="status status-pending">‚è≥ Pending</span></td>
        <td>
          <button onclick="approvePayment('${order.id}', '${order.orderId}')" class="btn btn-approve">‚úÖ Approve</button>
          <button onclick="rejectPayment('${order.id}', '${order.orderId}')" class="btn btn-reject">‚ùå Reject</button>
        </td>
      </tr>
    `;
  }).join('');
  
  console.log("‚úÖ Pending orders table loaded with buttons");
}

function loadApprovedOrders(orders){
  const approvedTable = document.getElementById("approvedTable");
  const approvedTableBody = document.getElementById("approvedTableBody");
  const approvedLoading = document.getElementById("approvedLoading");
  const approvedNoData = document.getElementById("approvedNoData");
  
  const approved = orders.filter(o => o.paymentStatus === PAYMENT_STATUS.APPROVED);
  
  console.log("‚úÖ Approved orders:", approved.length);
  
  approvedLoading.style.display = 'none';
  
  if(approved.length === 0){
    approvedTable.style.display = 'none';
    approvedNoData.style.display = 'block';
    return;
  }
  
  approvedTable.style.display = 'table';
  approvedNoData.style.display = 'none';
  
  approvedTableBody.innerHTML = approved.map(order => `
    <tr>
      <td><strong>${order.orderId}</strong></td>
      <td>${order.customer.name || 'N/A'}</td>
      <td>‚Çπ${(order.total || 0).toLocaleString('en-IN')}</td>
      <td style="color:var(--success);font-weight:bold;">${order.utr || 'N/A'}</td>
      <td><span class="status status-approved">‚úÖ Approved</span></td>
    </tr>
  `).join('');
}

// ============================================
// APPROVE/REJECT FUNCTIONS - GUARANTEED TO WORK
// ============================================
function approvePayment(firestoreId, orderId){
  console.log("‚úÖ Approving payment:", orderId, "Firestore ID:", firestoreId);
  updateDebugInfo(`Approving order: ${orderId}`);
  
  if(!confirm(`‚úÖ Approve payment for order ${orderId}?`)){ 
    return; 
  }
  
  db.collection('orders').doc(firestoreId).update({
    paymentStatus: PAYMENT_STATUS.APPROVED,
    paymentApprovedAt: firebase.firestore.FieldValue.serverTimestamp(),
    status: 'confirmed'
  })
  .then(() => {
    console.log("‚úÖ Payment approved successfully!");
    updateDebugInfo(`‚úÖ Approved: ${orderId}`);
    showToast("Payment approved! Order confirmed.", "success");
    loadDashboard();
  })
  .catch((err) => { 
    console.error("‚ùå Error approving payment:", err); 
    updateDebugInfo(`‚ùå Error: ${err.message}`);
    showToast("Error: " + err.message, "error"); 
  });
}

function rejectPayment(firestoreId, orderId){
  console.log("‚ùå Rejecting payment:", orderId, "Firestore ID:", firestoreId);
  updateDebugInfo(`Rejecting order: ${orderId}`);
  
  if(!confirm(`‚ùå Reject payment for order ${orderId}?`)){ 
    return; 
  }
  
  db.collection('orders').doc(firestoreId).update({
    paymentStatus: PAYMENT_STATUS.REJECTED
  })
  .then(() => {
    console.log("‚úÖ Payment rejected successfully!");
    updateDebugInfo(`‚ùå Rejected: ${orderId}`);
    showToast("Payment rejected", "error");
    loadDashboard();
  })
  .catch((err) => { 
    console.error("‚ùå Error rejecting payment:", err); 
    updateDebugInfo(`‚ùå Error: ${err.message}`);
    showToast("Error: " + err.message, "error"); 
  });
}

function updateDebugInfo(msg){
  document.getElementById("debugContent").innerHTML = `<code>${msg}</code>`;
}

function showToast(msg, type = "success"){
  const t = document.getElementById("toast");
  t.textContent = msg; 
  t.className = "toast" + (type === "error" ? " error" : "");
  t.style.display = "block"; 
  setTimeout(() => t.style.display = "none", 3000);
}
</script>

</body>
</html>
