<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Brandorivk - Admin Panel</title>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<style>
:root{ --primary:#6956ff; --line:#e9edfb; --text:#1a1a2e; --success:#27ae60; --danger:#e74c3c; --warning:#f39c12; --info:#3498db; }
*{ box-sizing:border-box; margin:0; padding:0; }
body{ font-family:Arial, sans-serif; background:#f5f7fb; color:var(--text); padding:20px; }
.container{ max-width:1200px; margin:0 auto; }
header{ background:#fff; padding:20px; border-radius:12px; margin-bottom:20px; box-shadow:0 2px 10px rgba(0,0,0,.1); display:flex; justify-content:space-between; align-items:center; }
h1{ color:var(--text); font-size:1.5rem; }
.stats{ display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:30px; }
.stat-card{ background:linear-gradient(135deg, var(--primary), #403ab4); color:#fff; padding:20px; border-radius:8px; text-align:center; }
.stat-card h3{ font-size:2rem; margin-bottom:5px; }
.stat-card p{ opacity:0.9; font-size:0.9rem; }
.section{ background:#fff; padding:20px; border-radius:12px; margin-bottom:20px; box-shadow:0 2px 10px rgba(0,0,0,.1); }
.section h2{ margin-bottom:20px; color:var(--text); border-bottom:2px solid var(--line); padding-bottom:10px; font-size:1.2rem; }
table{ width:100%; border-collapse:collapse; }
th, td{ padding:12px; text-align:left; border-bottom:1px solid var(--line); font-size:0.9rem; }
th{ background:#f8f9fa; font-weight:600; }
tr:hover{ background:#f8f9fa; }
.btn{ padding:6px 12px; border:none; border-radius:4px; cursor:pointer; font-size:0.85rem; margin:2px; }
.btn-approve{ background:var(--success); color:#fff; }
.btn-approve:hover{ opacity:0.9; }
.btn-reject{ background:var(--danger); color:#fff; }
.btn-reject:hover{ opacity:0.9; }
.btn-view{ background:var(--info); color:#fff; }
.btn-view:hover{ opacity:0.9; }
.btn-logout{ background:var(--danger); color:#fff; padding:10px 20px; }
.btn-logout:hover{ opacity:0.9; }
.status{ padding:6px 12px; border-radius:20px; font-size:0.85rem; font-weight:600; display:inline-block; }
.status-pending{ background:#ffeaa7; color:#d63031; }
.status-approved{ background:#55efc4; color:#00b894; }
.status-rejected{ background:#fab1a0; color:#d63031; }
.status-confirmed{ background:#fff3cd; color:#856404; }
.status-delivered{ background:#c3e6cb; color:#155724; }
.login-box{ max-width:400px; margin:100px auto; background:#fff; padding:40px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.1); }
.login-box h2{ text-align:center; margin-bottom:20px; color:var(--text); }
.form-group{ margin-bottom:15px; }
.form-group label{ display:block; margin-bottom:5px; font-weight:600; color:#333; }
.form-group input{ width:100%; padding:12px; border:2px solid var(--line); border-radius:8px; font-size:1rem; }
.form-group input:focus{ outline:none; border-color:var(--primary); }
.submit-btn{ width:100%; padding:15px; background:var(--primary); color:#fff; border:none; border-radius:8px; font-size:1.1rem; font-weight:700; cursor:pointer; }
.submit-btn:hover{ opacity:0.9; }
.toast{ position:fixed; bottom:20px; right:20px; background:var(--success); color:white; padding:12px 24px; border-radius:8px; z-index:1000; display:none; animation:slideIn .3s ease; }
.toast.error{ background:var(--danger); }
.hidden{ display:none; }
.loading{ text-align:center; padding:2rem; color:#666; }
.no-data{ text-align:center; padding:2rem; color:#666; }
@keyframes slideIn{ from{ transform:translateX(100%); opacity:0 } to{ transform:translateX(0); opacity:1 } }
@media(max-width:768px){
  .stats{ grid-template-columns:1fr 1fr; }
  table{ font-size:0.8rem; }
  th, td{ padding:8px; }
}
</style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen" class="login-box">
  <h2>üîê Admin Login</h2>
  <form onsubmit="adminLogin(event)">
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="adminEmail" required placeholder="brandorivk@gmail.com">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="adminPassword" required placeholder="Enter password">
    </div>
    <button type="submit" class="submit-btn">Login</button>
  </form>
</div>

<!-- Admin Dashboard -->
<div id="adminDashboard" class="container hidden">
  <header>
    <h1>üë®‚Äçüíº Admin Panel - Payment Verification</h1>
    <button onclick="adminLogout()" class="btn btn-logout">üö™ Logout</button>
  </header>

  <div class="stats">
    <div class="stat-card"><h3 id="statTotal">0</h3><p>Total Orders</p></div>
    <div class="stat-card" style="background:linear-gradient(135deg, #f39c12, #e67e22);"><h3 id="statPending">0</h3><p>Pending Payment</p></div>
    <div class="stat-card" style="background:linear-gradient(135deg, #3498db, #2980b9);"><h3 id="statApproved">0</h3><p>Payment Approved</p></div>
    <div class="stat-card" style="background:linear-gradient(135deg, #27ae60, #229954);"><h3 id="statDelivered">0</h3><p>Delivered</p></div>
  </div>

  <div class="section">
    <h2>‚è≥ Pending Payment Verifications (With UTR)</h2>
    <div id="pendingLoading" class="loading">Loading...</div>
    <table id="pendingTable" style="display:none;">
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Customer</th>
          <th>Phone</th>
          <th>Amount</th>
          <th>UTR Number</th>
          <th>Submitted</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="pendingTableBody"></tbody>
    </table>
    <div id="pendingNoData" class="no-data" style="display:none;">No pending payments</div>
  </div>

  <div class="section">
    <h2>üìã All Orders</h2>
    <div id="allOrdersLoading" class="loading">Loading...</div>
    <table id="allOrdersTable" style="display:none;">
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Customer</th>
          <th>Amount</th>
          <th>Payment</th>
          <th>Order Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="allOrdersTableBody"></tbody>
    </table>
    <div id="allOrdersNoData" class="no-data" style="display:none;">No orders yet</div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============================================
// FIREBASE CONFIG
// ============================================
const firebaseConfig = {
  apiKey: "AIzaSyBnYRf-mptGr3oA6ZqmJsjM9m6RCUz4mbM",
  authDomain: "brandorivk-9a3c2.firebaseapp.com",
  projectId: "brandorivk-9a3c2",
  storageBucket: "brandorivk-9a3c2.firebasestorage.app",
  messagingSenderId: "351821603694",
  appId: "1:351821603694:web:8b1181b5eaa2253b3a577f",
  measurementId: "G-WM887NHXE9"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const ADMIN_EMAIL = "brandorivk@gmail.com"; // ‚úÖ YOUR ADMIN EMAIL
const PAYMENT_STATUS = { PENDING: 'pending', APPROVED: 'approved', REJECTED: 'rejected' };
const ORDER_STATUS = { CONFIRMED: 'confirmed', DISPATCHED: 'dispatched', IN_TRANSIT: 'transit', DELIVERED: 'delivered' };

// ============================================
// AUTH
// ============================================
auth.onAuthStateChanged((user) => {
  console.log("üîê Admin auth state:", user ? user.email : "Logged out");
  
  if (user && user.email === ADMIN_EMAIL) {
    console.log("‚úÖ Admin logged in:", user.email);
    document.getElementById("loginScreen").classList.add("hidden");
    document.getElementById("adminDashboard").classList.remove("hidden");
    loadDashboard();
  } else {
    console.log("‚ùå Not admin or logged out");
    document.getElementById("loginScreen").classList.remove("hidden");
    document.getElementById("adminDashboard").classList.add("hidden");
  }
});

function adminLogin(e){
  e.preventDefault();
  const email = document.getElementById("adminEmail").value;
  const password = document.getElementById("adminPassword").value;
  
  console.log("üîê Admin login attempt:", email);
  
  if(email !== ADMIN_EMAIL){ 
    showToast("Not an admin account!", "error"); 
    return; 
  }
  
  auth.signInWithEmailAndPassword(email, password)
    .then(() => { 
      console.log("‚úÖ Admin login successful");
      showToast("Login successful!"); 
    })
    .catch((error) => { 
      console.error("‚ùå Admin login failed:", error.message);
      showToast("Login failed: " + error.message, "error"); 
    });
}

function adminLogout(){
  auth.signOut().then(() => { 
    console.log("üëã Admin logged out");
    showToast("Logged out"); 
  });
}

// ============================================
// DASHBOARD - FIXED WITH WORKING BUTTONS
// ============================================
function loadDashboard(){
  console.log("üìä Loading dashboard...");
  
  db.collection('orders').orderBy('orderDate', 'desc').get()
    .then((snapshot) => {
      console.log("üì¶ Orders loaded:", snapshot.size);
      
      const orders = snapshot.docs.map(doc => ({ 
        id: doc.id, 
        ...doc.data() 
      }));
      
      // Update Stats
      document.getElementById("statTotal").textContent = orders.length;
      document.getElementById("statPending").textContent = orders.filter(o => o.paymentStatus === PAYMENT_STATUS.PENDING && o.utr).length;
      document.getElementById("statApproved").textContent = orders.filter(o => o.paymentStatus === PAYMENT_STATUS.APPROVED).length;
      document.getElementById("statDelivered").textContent = orders.filter(o => o.status === ORDER_STATUS.DELIVERED).length;
      
      // Load Pending Payments (with UTR submitted)
      loadPendingPayments(orders);
      
      // Load All Orders
      loadAllOrders(orders);
      
    })
    .catch((err) => { 
      console.error("‚ùå Error loading orders:", err); 
      showToast("Error loading orders", "error");
    });
}

function loadPendingPayments(orders){
  const pendingTable = document.getElementById("pendingTable");
  const pendingTableBody = document.getElementById("pendingTableBody");
  const pendingLoading = document.getElementById("pendingLoading");
  const pendingNoData = document.getElementById("pendingNoData");
  
  // Filter: Payment pending AND UTR submitted
  const pending = orders.filter(o => o.paymentStatus === PAYMENT_STATUS.PENDING && o.utr);
  
  console.log("‚è≥ Pending payments with UTR:", pending.length);
  
  pendingLoading.style.display = 'none';
  
  if(pending.length === 0){
    pendingTable.style.display = 'none';
    pendingNoData.style.display = 'block';
    return;
  }
  
  pendingTable.style.display = 'table';
  pendingNoData.style.display = 'none';
  
  pendingTableBody.innerHTML = pending.map(order => {
    const submittedDate = order.paymentSubmittedAt ? 
      (order.paymentSubmittedAt.toDate ? order.paymentSubmittedAt.toDate().toLocaleString() : order.paymentSubmittedAt) 
      : '-';
    
    return `
      <tr>
        <td><strong>${order.orderId}</strong></td>
        <td>${order.customer.name || 'N/A'}</td>
        <td>${order.customer.phone || 'N/A'}</td>
        <td>‚Çπ${(order.total || 0).toLocaleString('en-IN')}</td>
        <td><strong style="color:var(--primary);">${order.utr || 'Not submitted'}</strong></td>
        <td><small>${submittedDate}</small></td>
        <td>
          <button onclick="approvePayment('${order.id}', '${order.orderId}')" class="btn btn-approve">‚úÖ Approve</button>
          <button onclick="rejectPayment('${order.id}', '${order.orderId}')" class="btn btn-reject">‚ùå Reject</button>
        </td>
      </tr>
    `;
  }).join('');
  
  console.log("‚úÖ Pending payments table loaded");
}

function loadAllOrders(orders){
  const allOrdersTable = document.getElementById("allOrdersTable");
  const allOrdersTableBody = document.getElementById("allOrdersTableBody");
  const allOrdersLoading = document.getElementById("allOrdersLoading");
  const allOrdersNoData = document.getElementById("allOrdersNoData");
  
  console.log("üìã All orders:", orders.length);
  
  allOrdersLoading.style.display = 'none';
  
  if(orders.length === 0){
    allOrdersTable.style.display = 'none';
    allOrdersNoData.style.display = 'block';
    return;
  }
  
  allOrdersTable.style.display = 'table';
  allOrdersNoData.style.display = 'none';
  
  const paymentLabels = { 
    [PAYMENT_STATUS.PENDING]: "‚è≥ Pending", 
    [PAYMENT_STATUS.APPROVED]: "‚úÖ Approved", 
    [PAYMENT_STATUS.REJECTED]: "‚ùå Rejected" 
  };
  
  const paymentClasses = { 
    [PAYMENT_STATUS.PENDING]: "status-pending", 
    [PAYMENT_STATUS.APPROVED]: "status-approved", 
    [PAYMENT_STATUS.REJECTED]: "status-rejected" 
  };
  
  const orderLabels = { 
    confirmed: "Confirmed", 
    dispatched: "Dispatched", 
    transit: "In Transit", 
    delivered: "Delivered" 
  };
  
  const orderClasses = { 
    confirmed: "status-confirmed", 
    dispatched: "status-confirmed", 
    transit: "status-confirmed", 
    delivered: "status-delivered" 
  };
  
  allOrdersTableBody.innerHTML = orders.map(order => {
    const paymentStatus = order.paymentStatus || PAYMENT_STATUS.PENDING;
    const orderStat = order.status || ORDER_STATUS.CONFIRMED;
    
    return `
      <tr>
        <td><strong>${order.orderId}</strong></td>
        <td>${order.customer.name || 'N/A'}</td>
        <td>‚Çπ${(order.total || 0).toLocaleString('en-IN')}</td>
        <td><span class="status ${paymentClasses[paymentStatus] || 'status-pending'}">${paymentLabels[paymentStatus] || 'Pending'}</span></td>
        <td><span class="status ${orderClasses[orderStat] || 'status-confirmed'}">${orderLabels[orderStat] || 'Confirmed'}</span></td>
        <td>
          <button onclick="viewOrder('${order.id}')" class="btn btn-view">üëÅÔ∏è View</button>
        </td>
      </tr>
    `;
  }).join('');
  
  console.log("‚úÖ All orders table loaded");
}

// ============================================
// PAYMENT APPROVAL/REJECTION - FIXED
// ============================================
function approvePayment(firestoreId, orderId){
  console.log("‚úÖ Approving payment:", orderId);
  
  if(!confirm(`Approve payment for order ${orderId}?`)){ 
    return; 
  }
  
  db.collection('orders').doc(firestoreId).update({
    paymentStatus: PAYMENT_STATUS.APPROVED,
    paymentApprovedAt: firebase.firestore.FieldValue.serverTimestamp(),
    status: ORDER_STATUS.CONFIRMED
  })
  .then(() => {
    console.log("‚úÖ Payment approved successfully");
    showToast("Payment approved! Order confirmed.", "success");
    loadDashboard(); // Reload to show updated status
  })
  .catch((err) => { 
    console.error("‚ùå Error approving payment:", err); 
    showToast("Error approving payment: " + err.message, "error"); 
  });
}

function rejectPayment(firestoreId, orderId){
  console.log("‚ùå Rejecting payment:", orderId);
  
  if(!confirm(`Reject payment for order ${orderId}?`)){ 
    return; 
  }
  
  db.collection('orders').doc(firestoreId).update({
    paymentStatus: PAYMENT_STATUS.REJECTED
  })
  .then(() => {
    console.log("‚úÖ Payment rejected successfully");
    showToast("Payment rejected", "error");
    loadDashboard(); // Reload to show updated status
  })
  .catch((err) => { 
    console.error("‚ùå Error rejecting payment:", err); 
    showToast("Error rejecting payment: " + err.message, "error"); 
  });
}

function viewOrder(firestoreId){
  console.log("üëÅÔ∏è Viewing order:", firestoreId);
  
  db.collection('orders').doc(firestoreId).get()
    .then((doc) => {
      if(doc.exists){
        const order = doc.data();
        const details = `
Order Details:
==============
Order ID: ${order.orderId}
Customer: ${order.customer.name}
Email: ${order.customer.email}
Phone: ${order.customer.phone}
Amount: ‚Çπ${order.total}
UTR: ${order.utr || 'Not submitted'}
Payment: ${order.paymentStatus}
Status: ${order.status}
Date: ${order.orderDate}
        `.trim();
        alert(details);
      } else {
        alert("Order not found");
      }
    })
    .catch((err) => {
      console.error("‚ùå Error viewing order:", err);
      alert("Error loading order details");
    });
}

function showToast(msg, type = "success"){
  const t = document.getElementById("toast");
  t.textContent = msg; 
  t.className = "toast" + (type === "error" ? " error" : "");
  t.style.display = "block"; 
  setTimeout(() => t.style.display = "none", 3000);
}
</script>

</body>
</html>
